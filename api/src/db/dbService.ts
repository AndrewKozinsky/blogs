import dotenv from 'dotenv'
import { MongoClient } from 'mongodb'

dotenv.config()

export const client = new MongoClient('mongodb://blogs-mongo:27017')
export const db = client.db('blogs')

export const dbService = {
	client: new MongoClient('mongodb://blogs-mongo:27017'),

	async runDb() {
		try {
			await this.client.connect()
			// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ —Å–¥–µ–ª–∞–≤ –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ë–î products.
			await this.client.db('products').command({ ping: 1 })
			console.log('Connected to DB ü¶Å')
		} catch {
			await this.close()
			console.log('Cannot connect to DB üê≤')
		}
	},

	async close() {
		await this.client.close()
	},

	async drop() {
		try {
			const collections = await db.listCollections().toArray()

			for (const collection of collections) {
				await db.collection(collection.name).deleteMany({})
			}

			return true
		} catch (err: unknown) {
			if (err instanceof Error) {
				console.log(err.message)
			}

			return false
		} finally {
			await this.client.close()
			// console.log('Connection successful closed')
		}
	},
}
